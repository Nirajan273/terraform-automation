name: "Proxmox GitOps"

on:
  push:
    branches: [ main ]
    paths:
      - "live/**"

env:
  TF_VAR_proxmox_api_url: ${{ secrets.PM_API_URL }}
  TF_VAR_proxmox_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
  TF_VAR_proxmox_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
  TF_VAR_proxmox_user: ${{ secrets.PM_USER }}
  TF_VAR_proxmox_password: ${{ secrets.PM_PASSWORD }}

jobs:
  # --- JOB 1: THE PLAN ---
  plan:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        # DEFINE YOUR TEAMS HERE
        include:
          - team_name: "Nirajan"
            path: "live/team-Nirajan"
          - team_name: "Alpha"
            path: "live/team-alpha"
    
    name: "Plan: ${{ matrix.team_name }}"
    outputs:
      # This maps the plan results so the Apply job knows if it should run
      should_apply: ${{ steps.check.outputs.changed }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: check
        name: Check for changes
        run: |
          # Only proceed if files in this specific path changed in this push
          if git diff --quiet ${{ github.event.before }} ${{ github.event.after }} -- "${{ matrix.path }}"; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes in ${{ matrix.path }}"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in ${{ matrix.path }}"
          fi

      - name: Terraform Init & Plan
        if: steps.check.outputs.changed == 'true'
        working-directory: ${{ matrix.path }}
        run: |
          terraform init
          terraform plan -no-color -out=tfplan

      - name: Upload Plan
        if: steps.check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.team_name }}-tfplan
          path: ${{ matrix.path }}/tfplan

  # --- JOB 2: THE APPLY (Requires Approval) ---
  apply:
    needs: plan
    runs-on: self-hosted
    strategy:
      matrix:
        include:
          - team_name: "Nirajan"
            path: "live/team-Nirajan"
          - team_name: "Alpha"
            path: "live/team-alpha"
    
    name: "Apply: ${{ matrix.team_name }}"
    environment: production # <--- Manual Approval button appears here
    # Only run if the Plan job detected changes for THIS specific matrix folder
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.team_name }}-tfplan
          path: ${{ matrix.path }}
        # This step will fail gracefully if no plan was uploaded (no changes)
        continue-on-error: true 

      - name: Terraform Apply
        # Only apply if the plan file actually exists
        run: |
          if [ -f "${{ matrix.path }}/tfplan" ]; then
            cd ${{ matrix.path }}
            terraform init
            terraform apply -auto-approve tfplan
          else
            echo "No plan file found for ${{ matrix.team_name }}. Skipping."
          fi